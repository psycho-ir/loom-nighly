name: Release Loom Project

# on:
#   schedule:
#     # * is a special character in YAML so you have to quote this string
#     - cron:  '0 0 * * *'
on:
  push:
    branches:
      - release-together

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout loom repository
        uses: actions/checkout@v2
        with:
          repository: openjdk/loom
          ref: fibers
          path: src
      - name: Check new commits
        run: |
          touch x.zip
          echo $(ls)
          cd src
          latest_release_tag=$(curl -H "Authorization: token $TOKEN"  https://api.github.com/repos/psycho-ir/loom-nightly/releases/latest | jq -r '.tag_name')
          version=$(git rev-parse --short HEAD)
          echo $latest_release_tag
          echo $version
          if [ "$latest_release_tag" == "$version" ]; then
             echo ::set-env name=CONTINUE::YES
          else
             echo ::set-env name=CONTINUE::YES
          fi

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: test-tag
          release_name: Nightly Release
          draft: false
          prerelease: false

      - name: Upload  Macos Release Asset
        id: upload-mac-release-asset
        uses: actions/upload-release-asset@v1.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./x.zip
          asset_name: jdk-loom-macos-nightly.zip
          asset_content_type: application/zip
      - name: Finish
        run: |
          echo 'Build finished successfully'
